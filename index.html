<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">   
	<title>Mi Página Web 2</title>
    <style>
        /* Ocultar mensajes mientras se están cargando */
        .embeddedMessagingConversationButton {
            opacity: 1 !important;
        }
        
        /* Ocultar el texto que se está cargando (streaming) */
        .message-streaming {
            display: none !important;
        }
        
        /* Indicador de carga personalizado */
        .custom-loading-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 10px;
            font-style: italic;
            color: #666;
        }
        
        .custom-loading-indicator .dot {
            width: 8px;
            height: 8px;
            background-color: #666;
            border-radius: 50%;
            animation: loadingDots 1.4s infinite ease-in-out both;
        }
        
        .custom-loading-indicator .dot:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .custom-loading-indicator .dot:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes loadingDots {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
<h1>Bienvenido a Mi Página Web</h1>
<script type="text/javascript">
    function initEmbeddedMessaging() {
        try {
            embeddedservice_bootstrap.settings.language = 'en_US';
            
            // Intentar múltiples configuraciones para desactivar streaming
            embeddedservice_bootstrap.settings.disableStreamingTokens = true;
            embeddedservice_bootstrap.settings.enableStreaming = false;
            embeddedservice_bootstrap.settings.streamingEnabled = false;

            embeddedservice_bootstrap.init(
                '00DG500000CPfYv',
                'AFC_ChannerChat',
                'https://onecrminetum--agentforce.sandbox.my.site.com/ESWChannelChat1761912240293',
                {
                    scrt2URL: 'https://onecrminetum--agentforce.sandbox.my.salesforce-scrt.com'
                }
            );
        } catch (err) {
            console.error('Error loading Embedded Messaging: ', err);
        }
    }
</script>

<script type="text/javascript" src="https://onecrminetum--agentforce.sandbox.my.site.com/ESWChannelChat1761912240293/assets/js/bootstrap.min.js" onload="initEmbeddedMessaging()"></script>

<script type="text/javascript">
    // Interceptar y acumular mensajes de streaming
    window.addEventListener("onEmbeddedMessagingReady", () => {
        console.log("Embedded Messaging está listo");
        
        let messageBuffer = new Map();
        let loadingIndicators = new Map();
        
        if (embeddedservice_bootstrap && embeddedservice_bootstrap.registerEventHandler) {
            
            // Escuchar cuando comienza un mensaje nuevo
            embeddedservice_bootstrap.registerEventHandler("MESSAGE_RECEIVED", (event) => {
                const data = event.data;
                console.log("Evento MESSAGE_RECEIVED:", data);
                
                // Si es el inicio del streaming, ocultar y mostrar indicador
                if (data.entryType === "StreamingToken") {
                    const messageId = data.id || 'current';
                    
                    // Acumular el mensaje
                    if (!messageBuffer.has(messageId)) {
                        messageBuffer.set(messageId, '');
                        
                        // Buscar el último mensaje del bot y ocultarlo
                        setTimeout(() => {
                            const chatMessages = document.querySelectorAll('[data-test="message-text"], .message-content, .embeddedServiceHelpArticleMessage');
                            if (chatMessages.length > 0) {
                                const lastMessage = chatMessages[chatMessages.length - 1];
                                
                                // Ocultar el mensaje que se está construyendo
                                lastMessage.classList.add('message-streaming');
                                
                                // Crear indicador de carga
                                if (!loadingIndicators.has(messageId)) {
                                    const loadingDiv = document.createElement('div');
                                    loadingDiv.className = 'custom-loading-indicator';
                                    loadingDiv.innerHTML = `
                                        <span>Escribiendo</span>
                                        <div class="dot"></div>
                                        <div class="dot"></div>
                                        <div class="dot"></div>
                                    `;
                                    loadingIndicators.set(messageId, loadingDiv);
                                    
                                    // Insertar después del mensaje oculto
                                    lastMessage.parentNode.insertBefore(loadingDiv, lastMessage.nextSibling);
                                }
                            }
                        }, 50);
                    }
                    
                    // Acumular tokens
                    messageBuffer.set(messageId, 
                        messageBuffer.get(messageId) + (data.entryPayload?.streamingToken?.token?.text || '')
                    );
                }
                
                // Cuando llega el mensaje completo
                if (data.entryType === "Message") {
                    const messageId = data.id || 'current';
                    
                    setTimeout(() => {
                        // Remover indicador de carga
                        const loadingIndicator = loadingIndicators.get(messageId);
                        if (loadingIndicator && loadingIndicator.parentNode) {
                            loadingIndicator.parentNode.removeChild(loadingIndicator);
                            loadingIndicators.delete(messageId);
                        }
                        
                        // Mostrar el mensaje completo
                        const chatMessages = document.querySelectorAll('.message-streaming');
                        chatMessages.forEach(msg => {
                            msg.classList.remove('message-streaming');
                        });
                        
                        // Limpiar buffer
                        messageBuffer.delete(messageId);
                    }, 100);
                }
            });
        }
    });
</script>

</body>
</html>



<!--
Guía de uso de utilAPI de Salesforce Embedded Messaging

1. ¿Qué es utilAPI?
utilAPI es una interfaz JavaScript que permite interactuar con el widget de chat de Salesforce Embedded Messaging desde tu página web.

2. Funciones principales:

- openWidget()
	Abre el widget de chat.
	Ejemplo:
	embeddedservice_bootstrap.utilAPI.openWidget();

- closeWidget()
	Cierra el widget de chat.
	Ejemplo:
	embeddedservice_bootstrap.utilAPI.closeWidget();

- isWidgetOpen()
	Devuelve true si el widget está abierto, false si está cerrado.
	Ejemplo:
	const abierto = embeddedservice_bootstrap.utilAPI.isWidgetOpen();

- minimizeWidget()
	Minimiza el widget de chat.
	Ejemplo:
	embeddedservice_bootstrap.utilAPI.minimizeWidget();

- maximizeWidget()
	Maximiza el widget de chat.
	Ejemplo:
	embeddedservice_bootstrap.utilAPI.maximizeWidget();

3. Uso típico:
Asegúrate de que embeddedservice_bootstrap.utilAPI esté disponible antes de llamar a sus métodos, normalmente después de que el script de bootstrap se haya cargado.

4. Ejemplo de integración:
<script>
	if (embeddedservice_bootstrap.utilAPI) {
		embeddedservice_bootstrap.utilAPI.openWidget();
	}
</script>

Consulta la documentación oficial de Salesforce para más detalles y métodos avanzados.
-->
